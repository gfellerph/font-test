{"version":3,"file":"parcel.service.js","sourceRoot":"","sources":["../../../../src/services/search/parcel.service.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,KAAK,EAAE,MAAM,kBAAkB,CAAC;AAIzC,iEAAiE;AAEjE,sBAAsB;AACtB,MAAM,CAAC,MAAM,sBAAsB,GAAG,CAAC,EAAU,EAAE,EAAE;EACnD,MAAM,IAAI,GAAG,KAAK,CAAC,eAAe,CAAC;EACnC,OAAO,uBAAuB,IAAI,yBAAyB,kBAAkB,CAAC,EAAE,CAAC,EAAE,CAAC;AACtF,CAAC,CAAC;AAEF,iBAAiB;AACjB,MAAM,CAAC,MAAM,2BAA2B,GAAG,CACzC,KAAa,EACb,EAAE,0BAA0B,EAAiB,EAC7C,EAAE;EACF,OAAO,0BAA0B,CAAC,OAAO,CAAC,kBAAkB,EAAE,kBAAkB,CAAC,KAAK,CAAC,CAAC,CAAC;AAC3F,CAAC,CAAC;AAEF;;;;;GAKG;AACH,MAAM,CAAC,MAAM,QAAQ,GAAG,KAAK,EAAE,KAAa,EAAE,YAA2B,EAAoB,EAAE;EAC7F,MAAM,UAAU,GAAG,MAAM,aAAa,CAAC,KAAK,EAAE,YAAY,CAAC,CAAC;EAC5D,OAAO,UAAU,CAAC,EAAE,CAAC;AACvB,CAAC,CAAC;AAEF;;;;;;GAMG;AACH,MAAM,CAAC,MAAM,aAAa,GAAG,KAAK,EAChC,KAAa,EACb,EAAE,eAAe,EAAiB,EACN,EAAE;EAC9B,MAAM,iBAAiB,GAAG,IAAI,MAAM,CAAC,eAAe,CAAC,CAAC;EAEtD,IAAI,iBAAiB,CAAC,IAAI,CAAC,KAAK,CAAC,EAAE;IACjC,IAAI;MACF,MAAM,mBAAmB,GAAG,MAAM,KAAK,CAAC,sBAAsB,CAAC,KAAK,CAAC,CAAC,CAAC;MACvE,MAAM,mBAAmB,GAAG,MAAM,mBAAmB,CAAC,IAAI,EAAE,CAAC;MAC7D,uCAAY,mBAAmB,KAAE,EAAE,EAAE,mBAAmB,CAAC,EAAE,KAAK,MAAM,IAAG;KAC1E;IAAC,OAAO,KAAK,EAAE;MACd,OAAO,CAAC,IAAI,CAAC,qDAAqD,KAAK,CAAC,OAAO,EAAE,CAAC,CAAC;KACpF;GACF;EAED,OAAO,EAAE,EAAE,EAAE,KAAK,EAAE,SAAS,EAAE,IAAI,IAAI,EAAE,CAAC,YAAY,EAAE,EAAE,CAAC;AAC7D,CAAC,CAAC;AAEF;;;;;GAKG;AACH,MAAM,CAAC,MAAM,mBAAmB,GAAG,KAAK,EACtC,KAAa,EACb,YAA2B,EAC4B,EAAE;EACzD,MAAM,UAAU,GAAG,MAAM,aAAa,CAAC,KAAK,EAAE,YAAY,CAAC,CAAC;EAC5D,OAAO,UAAU,CAAC,EAAE;IAClB,CAAC,iCAAM,UAAU,KAAE,GAAG,EAAE,2BAA2B,CAAC,KAAK,EAAE,YAAY,CAAC,IACxE,CAAC,CAAC,IAAI,CAAC;AACX,CAAC,CAAC","sourcesContent":["import { state } from '../../data/store';\r\nimport { ISearchConfig } from '../../models/header.model';\r\nimport { TrackAndTraceInfo } from '../../models/track-and-trace.model';\r\n\r\n// https://www.post.ch/api/trackandtrace?id=99.00.306600.01004883\r\n\r\n// Track and trace URL\r\nexport const getTrackAndTraceApiUrl = (id: string) => {\r\n  const lang = state.currentLanguage;\r\n  return `https://www.post.ch/${lang}/api/trackandtrace?id=${encodeURIComponent(id)}`;\r\n};\r\n\r\n// Get the redire\r\nexport const getTrackAndTraceRedirectUrl = (\r\n  query: string,\r\n  { packageTrackingRedirectUrl }: ISearchConfig,\r\n) => {\r\n  return packageTrackingRedirectUrl.replace('{trackingNumber}', encodeURIComponent(query));\r\n};\r\n\r\n/**\r\n * Check whether a query is a tracking id\r\n *\r\n * @param query User query\r\n * @returns Boolean\r\n */\r\nexport const isParcel = async (query: string, searchConfig: ISearchConfig): Promise<boolean> => {\r\n  const parcelInfo = await getParcelInfo(query, searchConfig);\r\n  return parcelInfo.ok;\r\n};\r\n\r\n/**\r\n * Try to get parcel info from a query that is possibly a tracking id.\r\n * This is mainly used to check if a search should redirect to track&trace instead of the regular search.\r\n *\r\n * @param query User query that is possibly a tracking number\r\n * @returns Track and trace info\r\n */\r\nexport const getParcelInfo = async (\r\n  query: string,\r\n  { redirectPattern }: ISearchConfig,\r\n): Promise<TrackAndTraceInfo> => {\r\n  const trackingNrPattern = new RegExp(redirectPattern);\r\n\r\n  if (trackingNrPattern.test(query)) {\r\n    try {\r\n      const trackAndTraceReqest = await fetch(getTrackAndTraceApiUrl(query));\r\n      const trackAndTraceResult = await trackAndTraceReqest.json();\r\n      return { ...trackAndTraceResult, ok: trackAndTraceResult.ok === 'true' };\r\n    } catch (error) {\r\n      console.warn(`Could not check track and trace API due to error: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  return { ok: false, timestamp: new Date().toDateString() };\r\n};\r\n\r\n/**\r\n * Get parcel info if query is a parcel or null\r\n *\r\n * @param query Parcel id\r\n * @returns Parcel info and a redirect url or null if not a parcel\r\n */\r\nexport const getParcelSuggestion = async (\r\n  query: string,\r\n  searchConfig: ISearchConfig,\r\n): Promise<(TrackAndTraceInfo & { url: string }) | null> => {\r\n  const parcelInfo = await getParcelInfo(query, searchConfig);\r\n  return parcelInfo.ok\r\n    ? { ...parcelInfo, url: getTrackAndTraceRedirectUrl(query, searchConfig) }\r\n    : null;\r\n};\r\n"]}